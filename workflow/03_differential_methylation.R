# ------------------------------------------------------------------------------
# Script:       03_differential_methylation.R
# Purpose:      Generates differentials for processed methylation data
# Author:       Sophia Li
# Affiliation:  Sadreyev lab
# Date:         2025-05-12
#
# Version:      R version 4.4.2 (2024-10-31)
# ------------------------------------------------------------------------------

# ===| A. Generate SLURM files |================================================

# --- Generates input files to send to a SLURM cluster to run BumpHunter ---
generate_slurm_files <- function(methylation_cohorts, cpg_anno, promoters, config) {
  
  # --- Generate candidate input methylation data ---
  all_beta <- cbind(assays(methylation_cohorts$grp1)$beta, 
                    assays(methylation_cohorts$grp2)$beta)
  
  # filter for CpGs overlapping promoter regions
  overlaps <- findOverlaps(cpg_anno, promoters, ignore.strand = TRUE)
  keep_cpgs <- cpg_anno$probeID[queryHits(overlaps)]
  all_beta <- all_beta[rownames(all_beta) %in% keep_cpgs, , drop = FALSE]
  
  # --- Generate genomic annotations and design matrix ---
  filtered_anno <- cpg_anno[cpg_anno$probeID %in% rownames(all_beta), ]
  filtered_anno <- filtered_anno[match(rownames(all_beta), filtered_anno$probeID), ]
  
  geno_anno <- data.frame(
    chr = as.character(seqnames(filtered_anno)),
    pos = start(filtered_anno)
  )
  
  group <- factor(c(rep(config$cohorts$group_1$name, ncol(methylation_cohorts$grp1)),
                    rep(config$cohorts$group_2$name, ncol(methylation_cohorts$grp2))))
  group <- relevel(group, config$cohorts$reference)
  design_matrix <- model.matrix(~ group)
  
  # --- Generate SLURM files ---
  
  # save input data for Bumphunter
  saveRDS(all_beta, file.path(paths$slurm_data, 
    paste0(config$general$dataset_name, "_slurm_data.rds")))
  saveRDS(geno_anno, file.path(paths$slurm_data,
    paste0(config$general$dataset_name, "_slurm_info.rds")))
  saveRDS(design_matrix, file.path(paths$slurm_data,
    paste0(config$general$dataset_name, "_slurm_design.rds")))
  
  # generate the analysis file using the template
  template_text <- readLines(file.path(paths$templates, "template_slurm_analysis.R"))
  params <- list(
    n_cores = config$general$n_cores,
    data_file = paste0(config$general$dataset_name, "_slurm_data.rds"),
    info_file = paste0(config$general$dataset_name, "_slurm_info.rds"),
    design_file = paste0(config$general$dataset_name, "_slurm_design.rds"),
    cutoff_q = config$methylation$diff$bumphunter$cutoff_q,
    max_gap = config$methylation$diff$bumphunter$max_gap,
    min_probes = config$methylation$diff$bumphunter$min_probes,
    permutations = config$methylation$diff$bumphunter$permutations,
    dmrs_file = paste0(config$general$dataset_name, "_raw_dmrs.rds")
  )
  template_string <- paste(template_text, collapse = "\n")
  filled_script <- glue_data(params, template_string, .open = "{{", .close = "}}")
  writeLines(filled_script, file.path(paths$slurm_scripts, paste0(
    config$general$dataset_name, "_slurm_analysis.R"
  )))
  
  # generate the job file using the template
  template_text <- readLines(file.path(paths$templates, "template_slurm_job.sh"))
  params <- list(
    job_name = paste0(config$general$dataset_name, "_dmrs"),
    output_file = file.path(
      config$general$slurm_scratch_path,
      paste0(config$general$dataset_name, "_dmrs_generation.out")),
    n_cores = config$general$n_cores,
    r_script = paste0(config$general$dataset_name, "_slurm_analysis.R")
  )
  template_string <- paste(template_text, collapse = "\n")
  filled_script <- glue_data(params, template_string, .open = "{{", .close = "}}")
  writeLines(filled_script, file.path(paths$slurm_scripts, paste0(
    config$general$dataset_name, "_slurm_job.sh"
  )))
}

# ===| B. Fetch Raw DMRs (Bumphunter results) |=================================

# --- Fetches raw DMRs generated by Bumphunter on a SLURM cluster ---
fetch_bumphunter_results <- function(paths) {
  
  message("Fetching Bumphunter results...")
  
  dmrs_path <- file.path(paths$results_methylation, paste0(dataset_name, "_raw_dmrs.rds"))
  
  if (file.exists(dmrs_path)) {
    message("Successfully found Bumphunter results")
    return(readRDS(dmrs_path))
  } else {
    stop("Bumphunter results could not be found")
  }
}

# ===| C. Filter DMRs for Significance |========================================

# --- Filters DMRs for EWAS-standard genome-wide significance ---
filter_dmrs <- function(raw_dmrs, paths, config) {
  
  message("Filtering Bumphunter results...")
  
  # --- Compute FDR via Bejamini-Hochberg procedure ---
  dmrs <- raw_dmrs$table
  dmrs$fdr <- p.adjust(dmrs$p.value, "BH")
  
  # --- Filter for significance based on configurations ---
  significant_dmrs <- dmrs[
    abs(dmrs$value) >= config$methylation$diff$dmr_effect_threshold &
      dmrs$fdr < config$methylation$diff$fdr_threshold, 
  ]
  
  # --- Process and standardize the significant DMRs ---
  significant_dmrs <- GRanges(
    seqnames = significant_dmrs$chr, 
    ranges = IRanges(start = significant_dmrs$start, end = significant_dmrs$end),
    value = significant_dmrs$value,
    pval = significant_dmrs$p.value,
    fdr = significant_dmrs$fdr
  )
  
  significant_dmrs <- keepStandardChromosomes(significant_dmrs, pruning.mode = "coarse")
  seqlevelsStyle(significant_dmrs) <- "UCSC"
  
  if (config$general$genome_build == "hg19") {
    seqinfo(significant_dmrs) <- seqinfo(BSgenome.Hsapiens.UCSC.hg19)[
      seqlevels(significant_dmrs)]
  } else {
    # ... add hg38 support
  }
  
  # --- Save and return the processed CpG probe annotation ---
  processed_path <- file.path(
    paths$results_methylation, 
    paste0(config$general$dataset_name, "_significant_dmrs.rds")
  )
  saveRDS(significant_dmrs, processed_path)
  message("Wrote significant DMRs to: ", processed_path)
  
  return(significant_dmrs)
}

# ===| D. Identify DMGs |=======================================================

# --- Identify DMGs from significant DMRs ---
identify_dmgs <- function(significant_dmrs, promoters, paths, config) {
  
  message("Identifying differentially methylated genes...")
  
  # --- Identify promoters overlapping significant DMRs ---
  overlaps <- findOverlaps(significant_dmrs, promoters, ignore.strand = TRUE)
  dmgs <- data.frame(
    symbol = promoters$symbol[subjectHits(overlaps)],
    delta_beta = mcols(significant_dmrs)$value[queryHits(overlaps)]
  )
  
  # --- Collapse multiple overlapping DMRs: mean delta beta ---
  dmgs <- dmgs %>%
    group_by(symbol) %>%
    summarize(
      numDMRs = n(),
      mean_delta_beta = mean(delta_beta),
      .groups = "drop"
    )
  
  # --- Save and return the processed result ---
  processed_path <- file.path(
    paths$results_methylation, 
    paste0(config$general$dataset_name, "_dmgs.rds")
  )
  saveRDS(dmgs, processed_path)
  processed_path <- file.path(
    paths$results_methylation, 
    paste0(config$general$dataset_name, "_dmgs.xlsx")
  )
  write_xlsx(dmgs, processed_path)
  
  message("Wrote DMGs to: ", processed_path)
  
  return(dmgs)
}


# ===| E. Split DMGs into Hyper/Hypomethylated |================================

split_dmgs <- function(dmgs, paths, config) {
  
  message("Splitting DMGs into hyper/hypomethylated...")
  
  split_dmgs <- list(
    all = dmgs,
    hypermethylated = dmgs[dmgs$mean_delta_beta > 0, ],
    hypomethylated = dmgs[dmgs$mean_delta_beta < 0, ]
  )
  
  # --- Save and return the processed CpG probe annotation ---
  processed_path <- file.path(
    paths$results_methylation, 
    paste0(config$general$dataset_name, "_dmgs.rds")
  )
  saveRDS(split_dmgs, processed_path)
  message("Wrote split DMGs to: ", processed_path)
  
  # save as a multi-sheet excel file
  processed_path <- file.path(
    paths$results_methylation, 
    paste0(config$general$dataset_name, "_dmgs.xlsx")
  )
  write_xlsx(split_dmgs, processed_path)
  
  return(split_dmgs)
}

